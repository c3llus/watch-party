erDiagram
    users {
        string id PK "UUID, PK"
        string email UK "Unique"
        string password_hash
        string role "e.g., 'user', 'admin'"
        datetime created_at
    }
    movies {
        string id PK "UUID, PK"
        string title
        string description
        string storage_provider "e.g., 'gcs', 'local'"
        string storage_path "Path to video file"
        int duration_seconds
        bigint file_size
        string mime_type
        string uploaded_by FK "FK to users"
        datetime created_at
    }
    rooms {
        string id PK "UUID, PK"
        string movie_id FK "FK to movies"
        string host_id FK "FK to users"
        datetime created_at
    }
    room_access {
        string user_id PK, FK "Composite PK, FK to users"
        string room_id PK, FK "Composite PK, FK to rooms"
        string access_type "granted | guest"
        string status "invited | granted"
        datetime granted_at
    }
    guest_access_requests {
        string id PK "UUID, PK"
        string room_id FK "FK to rooms"
        string guest_name
        text request_message
        string status "pending | approved | denied"
        datetime requested_at
        string reviewed_by FK "FK to users"
        datetime reviewed_at
    }
    room_invitations {
        string id PK "UUID, PK - DEPRECATED"
        string room_id FK "FK to rooms - DEPRECATED"
        string inviter_id FK "FK to users - DEPRECATED"
        string email "DEPRECATED"
        string token UK "Unique invitation token - DEPRECATED"
        text message "DEPRECATED"
        datetime expires_at "DEPRECATED"
        datetime used_at "DEPRECATED"
        datetime created_at "DEPRECATED"
    }
    room_sessions {
        string id PK "UUID, PK"
        string room_id FK "FK to rooms"
        string host_id FK "FK to users"
        string movie_id FK "FK to movies"
        string session_name
        datetime created_at
        datetime ended_at
    }
    room_session_events {
        string id PK "UUID, PK"
        string session_id FK "FK to room_sessions"
        string user_id FK "FK to users"
        string event_type "join|leave|play|pause|seek|rate_change"
        jsonb event_data "Flexible event data"
        real video_time "Video position at event"
        datetime timestamp
    }
    tokens {
        string id PK "UUID, PK"
        string user_id FK "FK to users"
        string value "Token hash"
        datetime created_at
    }

    %% Relationships
    users ||--o{ room_access : "is member of"
    users ||--o{ rooms : "hosts"
    users ||--o{ movies : "uploads"
    users ||--o{ room_sessions : "hosts session"
    users ||--o{ room_session_events : "generates events"
    users ||--o{ tokens : "has refresh tokens"
    users ||--o{ guest_access_requests : "reviews requests"
    
    rooms ||--|{ room_access : "has members"
    rooms }|--|| movies : "plays"
    rooms ||--o{ room_sessions : "has sessions"
    rooms ||--o{ guest_access_requests : "receives requests"
    
    room_sessions ||--o{ room_session_events : "contains events"
    room_sessions }|--|| movies : "plays movie"